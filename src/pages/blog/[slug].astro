---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import Breadcrumbs from '@components/Breadcrumbs.astro';
import CTASection from '@components/CTASection.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { data } = post;
const { Content } = await post.render();

const breadcrumbs = [
  { label: 'Acasă', href: '/' },
  { label: 'Blog', href: '/blog' },
  { label: data.title },
];

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('ro-RO', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
}

// Get related posts (same category, excluding current)
const allPosts = await getCollection('blog', ({ data: d }) => !d.draft);
const relatedPosts = allPosts
  .filter((p) => p.slug !== post.slug && p.data.category === data.category)
  .slice(0, 3);
---

<BaseLayout
  title={`${data.title} | Blog | Apartamente Gara Peris`}
  description={data.description}
>
  <Header slot="header" currentPage="blog" />

  <!-- Intro Section -->
  <section class="intro-single">
    <div class="container">
      <div class="row">
        <div class="col-md-12 col-lg-8">
          <div class="title-single-box">
            <h1 class="title-single">{data.title}</h1>
            <div class="post-meta">
              <span class="post-date">
                <i class="bi bi-calendar3 me-1"></i>
                {formatDate(data.pubDate)}
              </span>
              <span class="post-category ms-3">
                <i class="bi bi-folder me-1"></i>
                {data.category}
              </span>
              <span class="post-author ms-3">
                <i class="bi bi-person me-1"></i>
                {data.author}
              </span>
            </div>
          </div>
        </div>
        <div class="col-md-12 col-lg-4">
          <Breadcrumbs items={breadcrumbs} />
        </div>
      </div>
    </div>
  </section>

  <!-- Blog Post Section -->
  <section class="section-blog-post">
    <div class="container">
      <div class="row">
        <div class="col-lg-8">
          <!-- Featured Image -->
          {data.image && (
            <div class="post-featured-image mb-4">
              <img
                src={data.image.src}
                alt={data.image.alt}
                class="img-fluid rounded"
              />
            </div>
          )}

          <!-- Post Content -->
          <article class="post-content">
            <Content />
          </article>

          <!-- Tags -->
          {data.tags && data.tags.length > 0 && (
            <div class="post-tags mt-4 pt-4 border-top">
              <i class="bi bi-tags me-2"></i>
              {data.tags.map((tag) => (
                <span class="badge bg-light text-dark me-2">{tag}</span>
              ))}
            </div>
          )}

          <!-- Share -->
          <div class="post-share mt-4 pt-4 border-top">
            <span class="share-label me-3">Distribuie:</span>
            <a
              href={`https://www.facebook.com/sharer/sharer.php?u=${Astro.url}`}
              target="_blank"
              class="btn btn-outline-primary btn-sm me-2"
            >
              <i class="bi bi-facebook"></i>
            </a>
            <a
              href={`https://wa.me/?text=${encodeURIComponent(data.title + ' ' + Astro.url)}`}
              target="_blank"
              class="btn btn-outline-success btn-sm me-2"
            >
              <i class="bi bi-whatsapp"></i>
            </a>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
          <aside class="blog-sidebar">
            <!-- About Box -->
            <div class="sidebar-box mb-4">
              <h4 class="sidebar-title">Despre noi</h4>
              <p class="text-muted">
                Oferim apartamente moderne în Gara Peris, cu acces rapid la București și la prețuri accesibile.
              </p>
              <a href="/despre" class="btn btn-outline-success btn-sm">
                Află mai multe
              </a>
            </div>

            <!-- CTA Box -->
            <div class="sidebar-box cta-box mb-4">
              <h4 class="sidebar-title text-white">Interesat de un apartament?</h4>
              <p class="text-white-50 mb-3">
                Contactează-ne pentru detalii sau programează o vizită.
              </p>
              <a href="/contact" class="btn btn-light btn-sm">
                Contactează-ne
              </a>
            </div>

            <!-- Related Posts -->
            {relatedPosts.length > 0 && (
              <div class="sidebar-box mb-4">
                <h4 class="sidebar-title">Articole similare</h4>
                <ul class="related-posts-list">
                  {relatedPosts.map((related) => (
                    <li class="related-post-item">
                      <a href={`/blog/${related.slug}`}>
                        <div class="d-flex">
                          {related.data.image && (
                            <img
                              src={related.data.image.src}
                              alt={related.data.image.alt}
                              class="related-post-img"
                            />
                          )}
                          <div class="related-post-info">
                            <h5>{related.data.title}</h5>
                            <span class="text-muted small">
                              {formatDate(related.data.pubDate)}
                            </span>
                          </div>
                        </div>
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </aside>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <CTASection />

  <Footer slot="footer" />
</BaseLayout>

<style>
  .post-meta {
    color: #888;
    font-size: 0.9rem;
    margin-top: 10px;
  }

  .post-featured-image img {
    width: 100%;
    max-height: 400px;
    object-fit: cover;
  }

  .post-content {
    background: #fff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
  }

  .post-content :global(h2) {
    color: #2eca6a;
    font-size: 1.5rem;
    margin-top: 30px;
    margin-bottom: 15px;
  }

  .post-content :global(h3) {
    color: #333;
    font-size: 1.25rem;
    margin-top: 25px;
    margin-bottom: 12px;
  }

  .post-content :global(p) {
    color: #555;
    line-height: 1.8;
    margin-bottom: 15px;
  }

  .post-content :global(ul),
  .post-content :global(ol) {
    color: #555;
    padding-left: 20px;
    margin-bottom: 15px;
  }

  .post-content :global(li) {
    margin-bottom: 8px;
  }

  .post-content :global(strong) {
    color: #333;
  }

  .post-content :global(a) {
    color: #2eca6a;
  }

  .post-content :global(blockquote) {
    border-left: 4px solid #2eca6a;
    padding-left: 20px;
    margin: 20px 0;
    font-style: italic;
    color: #666;
  }

  .post-content :global(hr) {
    margin: 30px 0;
    border-color: #eee;
  }

  .share-label {
    font-weight: 600;
    color: #333;
  }

  .sidebar-box {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 8px;
  }

  .sidebar-box.cta-box {
    background: #2eca6a;
  }

  .sidebar-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: #333;
  }

  .sidebar-box.cta-box .sidebar-title {
    color: #fff;
  }

  .related-posts-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .related-post-item {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
  }

  .related-post-item:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .related-post-item a {
    text-decoration: none;
    color: inherit;
  }

  .related-post-img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
    margin-right: 12px;
  }

  .related-post-info h5 {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 5px;
    color: #333;
    line-height: 1.3;
  }

  .related-post-item:hover .related-post-info h5 {
    color: #2eca6a;
  }
</style>
